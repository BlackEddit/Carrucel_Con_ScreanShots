<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carousel Link</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#0b0f13; color:#eee; }
    header { padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    .wrap { display:grid; place-items:center; height: calc(100vh - 60px); }
    img {
      width: 100vw;
      height: auto;
      max-width: 100vw;
      max-height: 100vh;
      border-radius: 0;
      box-shadow: none;
      background: #111;
      display: block;
      margin: 0 auto;
      object-fit: contain;
    }
    .pill { font-size:12px; opacity:.7 }
    .controls { display:flex; gap:8px; }
    button { background:#1e2836; color:#d2f7d0; border:1px solid #243246; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    
    /* Pantalla de carga */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #0b0f13;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: #eee;
    }
    
    .loading-text {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid #1e2836;
      border-top: 3px solid #d2f7d0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .dashboard-count {
      margin-top: 20px;
      font-size: 16px;
      opacity: 0.7;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Pantalla de carga inicial -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-text">üîÑ Cargando Dashboards...</div>
    <div class="spinner"></div>
    <div id="progress-info" class="dashboard-count">
      Capturando screenshots de los dashboards<br>
      <span id="progress-text">Iniciando...</span>
    </div>
  </div>
  
  <!-- Encabezado y controles eliminados para mostrar solo la imagen -->
  <div class="wrap">
    <img id="frame" alt="slide" />
  </div>
  <script>
    let idx = 0, items = [], timer = null;
    const loadingScreen = document.getElementById('loading-screen');

    async function loadList(){
      try {
        const res = await fetch('/api/list');
        const data = await res.json();
        items = data.items.filter(x => !!x); // ignora vac√≠os
        
        // Actualizar informaci√≥n de progreso
        updateProgress(data);
        
        // CARRUSEL PROGRESIVO: Arrancar tan pronto como haya al menos 1 dashboard
        if (items.length > 0) {
          loadingScreen.classList.add('hidden');
          
          // Si es la primera vez que tenemos dashboards, arrancar carrusel
          if (!timer) {
            console.log(`üöÄ Iniciando carrusel con ${items.length} dashboard(s) disponible(s)`);
            show(0);
            play();
          }
        } else {
          // Si no hay im√°genes, mantiene la pantalla de carga
          loadingScreen.classList.remove('hidden');
        }
      } catch (error) {
        console.log('Error cargando lista:', error);
        // Mantiene pantalla de carga si hay error
      }
    }
    
    function updateProgress(data) {
      const progressText = document.getElementById('progress-text');
      if (data.loading && data.total > 0) {
        const percentage = Math.round((data.progress / data.total) * 100);
        const successful = data.successful || 0;
        const failed = data.failed || 0;
        const available = data.available || 0;
        progressText.innerHTML = `
          Progreso: ${data.progress}/${data.total} dashboards (${percentage}%)<br>
          ‚úÖ Disponibles: ${available} | ‚ùå Fallidos: ${failed}<br>
          ${available > 0 ? 'üéØ Carrusel funcionando con dashboards disponibles' : '‚è≥ Esperando primer dashboard...'}
        `;
      } else if (!data.loading && data.total > 0) {
        const successful = data.successful || 0;
        const failed = data.failed || 0;
        progressText.innerHTML = `
          ‚úÖ Completado: ${successful} exitosos de ${data.total} dashboards<br>
          ${failed > 0 ? `‚ö†Ô∏è ${failed} dashboards fallaron` : 'üéâ Todos los dashboards capturados exitosamente'}
        `;
      } else {
        progressText.textContent = 'Iniciando captura de dashboards...';
      }
    }

    function show(i){
      if (!items.length) return;
      idx = (i + items.length) % items.length;
      document.getElementById('frame').src = items[idx].img + `?t=${Date.now()}`; // cache-bust
    }

    function play(){
      stop();
      const s = 14000; // 14 segundos
      timer = setInterval(() => show(idx+1), s);
    }
    function stop(){ if (timer) clearInterval(timer); timer = null; }

    // Inicia carga inicial
    loadList();
    
    // CARRUSEL PROGRESIVO: Revisa cada 5 segundos durante la carga inicial
    const progressiveCheck = setInterval(() => {
      loadList().then(() => {
        // Si ya termin√≥ la carga completa, cambiar a revisi√≥n normal
        if (!items.loading || items.length >= 12) {
          console.log(`üéØ Carga completa o suficientes dashboards. Cambiando a revisi√≥n cada 2 minutos.`);
          clearInterval(progressiveCheck);
          // Despu√©s revisa cada 2 minutos normalmente
          setInterval(loadList, 120000);
        }
      });
    }, 5000); // Cada 5 segundos durante la carga inicial
  </script>
</body>
</html>
